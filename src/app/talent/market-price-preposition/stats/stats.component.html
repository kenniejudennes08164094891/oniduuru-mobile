<!-- stats.component.html -->
<div class="mb-6">
  <!-- Header - Responsive -->
  <div
    class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4"
  >
    <h3
      class="text-base sm:text-lg font-semibold text-gray-800 break-words pr-2"
    >
      Performance Rating by Percentage %
      <span
        *ngIf="selectedScouter?.name"
        class="block sm:inline text-sm sm:text-base font-normal text-gray-600 mt-1 sm:mt-0 sm:ml-2"
      >
        - {{ selectedScouter.name }}
      </span>
    </h3>
    <div class="flex items-center gap-2 self-end sm:self-auto">
      <span
        class="text-[10px] sm:text-xs px-2 sm:px-3 py-1 rounded-full font-medium whitespace-nowrap"
        [ngClass]="{
          'bg-green-100 text-green-800': hasRealData,
          'bg-yellow-100 text-yellow-800': !hasRealData,
        }"
      >
        {{ dataSourceInfo }}
      </span>
      <span
        *ngIf="isLoading"
        class="text-[10px] sm:text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded-full whitespace-nowrap"
      >
        Loading...
      </span>
    </div>
  </div>

  <!-- Add a loading or empty state when no scouter -->
  <div *ngIf="!selectedScouter" class="text-center py-12">
    <ion-icon
      name="person-outline"
      class="text-5xl text-gray-300 mb-3"
    ></ion-icon>
    <p class="text-gray-500">No scouter selected</p>
    <p class="text-sm text-gray-400 mt-1">
      Please select a scouter from the engagements tab
    </p>
  </div>

  <div *ngIf="selectedScouter">
    <!-- Performance Score Card - Responsive -->
    <div
      class="mb-4 p-4 sm:p-5 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border border-indigo-200 shadow-sm"
    >
      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3"
      >
        <div class="w-full sm:w-auto">
          <p class="text-xs sm:text-sm text-gray-600">
            Overall Performance Score
          </p>
          <div class="flex items-baseline gap-2 flex-wrap">
            <span
              class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-800"
              >{{ performanceMetrics.performanceScore.toFixed(0) }}/100</span
            >
            <span
              class="text-xs sm:text-sm px-2 py-1 rounded-full font-medium"
              [ngClass]="performanceScoreClass"
            >
              {{ performanceLabel }}
            </span>
          </div>
        </div>
        <div class="text-left sm:text-right w-full sm:w-auto">
          <p class="text-xs sm:text-sm text-gray-600">Engagement Success</p>
          <p class="text-lg sm:text-xl lg:text-2xl font-bold text-purple-600">
            {{ performanceMetrics.successRate.toFixed(0) }}%
          </p>
        </div>
      </div>
    </div>

    <!-- Performance Metrics Grid - Responsive -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
      <!-- Your Average Rating -->
      <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 shadow-sm">
        <div class="flex items-center justify-between">
          <p class="text-[10px] sm:text-xs text-gray-600 truncate">
            Your Rating
          </p>
          <span class="text-blue-600 text-xs sm:text-sm">‚≠ê</span>
        </div>
        <p class="text-base sm:text-lg font-bold text-blue-700">
          {{ performanceMetrics.yourRating.toFixed(1) }}/5
        </p>
        <div class="w-full bg-blue-200 rounded-full h-1.5 mt-1">
          <div
            class="bg-blue-600 h-1.5 rounded-full transition-all duration-300"
            [style.width]="(performanceMetrics.yourRating / 5) * 100 + '%'"
          ></div>
        </div>
      </div>

      <!-- Scouter's Rating -->
      <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 shadow-sm">
        <div class="flex items-center justify-between">
          <p class="text-[10px] sm:text-xs text-gray-600 truncate">
            {{ selectedScouter?.name || "Scouter" | slice: 0 : 12
            }}{{
              (selectedScouter?.name || "Scouter").length > 12 ? "..." : ""
            }}'s Rating
          </p>
          <span class="text-gray-600 text-xs sm:text-sm">‚≠ê</span>
        </div>
        <p class="text-base sm:text-lg font-bold text-gray-700">
          {{ performanceMetrics.scouterRating.toFixed(1) }}/5
        </p>
        <div class="w-full bg-gray-300 rounded-full h-1.5 mt-1">
          <div
            class="bg-gray-600 h-1.5 rounded-full transition-all duration-300"
            [style.width]="(performanceMetrics.scouterRating / 5) * 100 + '%'"
          ></div>
        </div>
      </div>

      <!-- Total Engagements -->
      <div class="bg-green-50 p-3 rounded-lg border border-green-100 shadow-sm">
        <div class="flex items-center justify-between">
          <p class="text-[10px] sm:text-xs text-gray-600 truncate">
            Engagements
          </p>
          <span class="text-green-600 text-xs sm:text-sm">üìä</span>
        </div>
        <div class="flex items-baseline gap-1 flex-wrap">
          <p class="text-base sm:text-lg font-bold text-green-700">
            {{ performanceMetrics.totalEngagements }}
          </p>
          <p class="text-[10px] sm:text-xs text-gray-500">
            ({{ performanceMetrics.ratedEngagements }} rated)
          </p>
        </div>
        <p class="text-[10px] sm:text-xs text-gray-500 mt-1">Market data</p>
      </div>

      <!-- Average Rating -->
      <div
        class="bg-purple-50 p-3 rounded-lg border border-purple-100 shadow-sm"
      >
        <div class="flex items-center justify-between">
          <p class="text-[10px] sm:text-xs text-gray-600 truncate">
            Avg. Rating
          </p>
          <span class="text-purple-600 text-xs sm:text-sm">üìà</span>
        </div>
        <p class="text-base sm:text-lg font-bold text-purple-700">
          {{ performanceMetrics.averageRating.toFixed(1) }}/5
        </p>
        <div class="flex items-center gap-1 mt-1">
          <div class="text-xs text-yellow-500">
            {{ getStars(performanceMetrics.averageRating) }}
          </div>
          <span class="text-[10px] sm:text-xs text-gray-500">avg</span>
        </div>
      </div>
    </div>

    <!-- Performance Distribution Chart - FIXED: Flex from TAB screens and above (640px) -->
    <div
      class="bg-white p-4 sm:p-6 rounded-xl border border-gray-200 shadow-sm mb-4"
    >
      <h4 class="text-sm sm:text-base font-semibold text-gray-700 mb-4">
        Performance Distribution
      </h4>

      <!-- FIXED: flex-col on mobile, flex-row from tablet (sm:flex-row) -->
      <div
        class="flex flex-col sm:flex-row gap-6 sm:gap-8 items-center sm:items-start"
      >
        <!-- Chart Container - Responsive width -->
        <div class="relative w-full sm:w-1/2 lg:w-2/3 flex justify-center">
          <div style="width: 100%; max-width: 350px; height: 350px">
            <canvas
              baseChart
              [data]="pieChartData"
              [options]="pieChartOptions"
              [type]="'pie'"
              style="display: block; width: 100%; height: 100%"
            ></canvas>
          </div>
        </div>

        <!-- Legend Indicators - FIXED: Responsive grid -->
        <div class="w-full sm:w-1/2 lg:w-1/3">
          <!-- Single column on mobile, 2 columns on tablet, 1 column on desktop -->
          <div class="">
            <div
              *ngFor="let item of legendItems"
              class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 transition-colors"
            >
              <span
                class="w-4 h-4 rounded-sm flex-shrink-0"
                [style.backgroundColor]="item.color"
              ></span>
              <span
                class="text-xs sm:text-sm text-gray-700 flex-1 break-words pr-2"
                >{{ item.label }}</span
              >
              <span
                class="text-xs sm:text-sm font-semibold text-gray-900 whitespace-nowrap"
                >{{ item.value }}%</span
              >
            </div>
          </div>

          <!-- Total engagements summary (optional - can add if needed) -->
          <div class="mt-4 pt-3 border-t border-gray-100">
            <div class="flex justify-between items-center">
              <span class="text-xs text-gray-500">Total Engagements</span>
              <span class="text-sm font-bold text-gray-800">{{
                performanceMetrics.totalEngagements
              }}</span>
            </div>
            <div class="flex justify-between items-center mt-1">
              <span class="text-xs text-gray-500">Rated Engagements</span>
              <span class="text-sm font-bold text-green-600">{{
                performanceMetrics.ratedEngagements
              }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rating History Section -->
  <div class="text-sm">
    <!-- Warning/Info Message - Responsive -->
    <div
      class="mb-4 p-3 sm:p-4 rounded-xl"
      [ngClass]="{
        'bg-yellow-50 border border-yellow-200': warningMessage.includes('‚ö†Ô∏è'),
        'bg-blue-50 border border-blue-200': !warningMessage.includes('‚ö†Ô∏è'),
      }"
    >
      <div class="flex items-start gap-2 sm:gap-3">
        <div class="flex-shrink-0">
          <ion-icon
            [name]="
              warningMessage.includes('‚ö†Ô∏è')
                ? 'warning-outline'
                : 'information-circle-outline'
            "
            [class]="
              warningMessage.includes('‚ö†Ô∏è')
                ? 'text-yellow-600 text-lg sm:text-xl'
                : 'text-blue-600 text-lg sm:text-xl'
            "
          >
          </ion-icon>
        </div>
        <div class="flex-1 min-w-0">
          <p
            class="text-xs sm:text-sm font-medium mb-1 break-words"
            [ngClass]="
              warningMessage.includes('‚ö†Ô∏è')
                ? 'text-yellow-800'
                : 'text-blue-800'
            "
          >
            {{ warningMessage }}
          </p>
          <p
            class="text-[10px] sm:text-xs break-words"
            [ngClass]="
              warningMessage.includes('‚ö†Ô∏è')
                ? 'text-yellow-700'
                : 'text-blue-700'
            "
          >
            Based on {{ performanceMetrics.totalEngagements }} engagement{{
              performanceMetrics.totalEngagements !== 1 ? "s" : ""
            }}
            with {{ selectedScouter?.name || "scouter" | slice: 0 : 20
            }}{{
              (selectedScouter?.name || "scouter").length > 20 ? "..." : ""
            }}
          </p>
        </div>
      </div>
    </div>

    <!-- Detailed Rating Analysis - WITH PROPER SPACING AND SCROLLABLE -->
    <div
      class="bg-white p-4 sm:p-6 rounded-xl border border-gray-200 shadow-sm mb-6"
    >
      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-6"
      >
        <h4 class="text-sm sm:text-base font-semibold text-gray-800">
          Detailed Rating Analysis
        </h4>
        <div class="flex flex-wrap gap-4 sm:gap-6 text-xs sm:text-sm">
          <span class="flex items-center gap-2">
            <span class="w-3 h-3 bg-blue-500 rounded-sm"></span>
            <span class="text-gray-600">Your rating</span>
          </span>
          <span class="flex items-center gap-2">
            <span class="w-3 h-3 bg-gray-600 rounded-sm"></span>
            <span class="text-gray-600">
              {{ selectedScouter?.name || "Scouter" | slice: 0 : 15
              }}{{
                (selectedScouter?.name || "Scouter").length > 15 ? "..." : ""
              }}'s rating
            </span>
          </span>
        </div>
      </div>

      <!-- Bar Chart Container - WITH HORIZONTAL SCROLL -->
      <div class="relative">
        <!-- Horizontal scroll container -->
        <div
          class="overflow-x-auto pb-4 -mb-2 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100"
        >
          <!-- Chart wrapper with minimum width -->
          <div class="min-w-[800px] lg:min-w-full px-1">
            <!-- Chart container -->
            <div style="height: 500px; width: 100%; position: relative">
              <canvas
                baseChart
                [data]="barChartData"
                [options]="cachedBarChartOptions || barChartOptions"
                [type]="'bar'"
                style="display: block; width: 100%; height: 100%"
              ></canvas>
            </div>
          </div>
        </div>

        <!-- Scroll indicator for mobile -->
        <div class="flex justify-end mt-1 text-xs text-gray-400 sm:hidden">
          <span class="flex items-center gap-1">
            <ion-icon name="chevron-forward-outline" class="text-xs"></ion-icon>
            Scroll horizontally
          </span>
        </div>
      </div>
    </div>

    <!-- Engagement History List - Responsive with Pagination -->
    <div
      class="bg-white p-3 sm:p-4 rounded-xl border border-gray-200 shadow-sm"
    >
      <div
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 mb-3"
      >
        <div>
          <h5 class="text-sm sm:text-base font-semibold text-gray-700">
            Engagement History
          </h5>
          <p class="text-[10px] sm:text-xs text-gray-500 mt-0.5">
            Showing {{ paginatedRatingList.length }} of
            {{ ratingList.length }} engagements
          </p>
        </div>
        <span
          class="text-[10px] sm:text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full whitespace-nowrap"
        >
          {{ performanceMetrics.totalEngagements }} total
        </span>
      </div>

      <!-- Engagement Cards - Responsive -->
      <div class="space-y-2">
        <div
          *ngFor="let item of paginatedRatingList"
          class="flex flex-col sm:flex-row sm:items-center justify-between p-3 hover:bg-gray-50 rounded-lg transition-colors border border-gray-100 gap-3"
        >
          <div class="flex items-start sm:items-center gap-2 sm:gap-3 flex-1">
            <span
              class="w-7 h-7 sm:w-8 sm:h-8 flex items-center justify-center rounded-full border-2 text-xs sm:text-sm font-medium flex-shrink-0"
              [ngClass]="{
                'border-green-500 bg-green-50 text-green-700': item.hasRating,
                'border-gray-300 bg-gray-50 text-gray-500': !item.hasRating,
              }"
            >
              #{{ item.number }}
            </span>

            <div class="flex-1 min-w-0">
              <p
                class="text-xs sm:text-sm font-medium text-gray-800 break-words"
              >
                Engagement #{{ item.number }}
              </p>
              <p class="text-[10px] sm:text-xs text-gray-500 break-words">
                {{ item.date }}
              </p>
            </div>
          </div>

          <div
            class="flex items-center justify-start sm:justify-end gap-4 sm:gap-6 ml-9 sm:ml-0"
          >
            <!-- Your Rating -->
            <div class="text-center min-w-[60px] sm:min-w-[70px]">
              <p class="text-[10px] sm:text-xs text-gray-600">You</p>
              <div class="flex items-center justify-center gap-0.5 sm:gap-1">
                <span class="text-xs sm:text-sm font-bold text-blue-600">
                  {{ item.yourRating.split(" ")[0] }}
                </span>
                <span
                  class="text-[10px] sm:text-xs text-blue-400"
                  *ngIf="item.yourRating !== 'No rating'"
                  >‚≠ê</span
                >
              </div>
              <p
                class="text-[8px] sm:text-[10px] text-gray-500 truncate max-w-[60px] sm:max-w-[80px]"
                *ngIf="item.yourRating !== 'No rating'"
              >
                {{ item.yourRating.split("stars")[1] || "" }}
              </p>
            </div>

            <!-- Scouter Rating -->
            <div class="text-center min-w-[60px] sm:min-w-[70px]">
              <p class="text-[10px] sm:text-xs text-gray-600">Scouter</p>
              <div class="flex items-center justify-center gap-0.5 sm:gap-1">
                <span class="text-xs sm:text-sm font-bold text-gray-700">
                  {{ item.scouterRating.split(" ")[0] }}
                </span>
                <span
                  class="text-[10px] sm:text-xs text-gray-400"
                  *ngIf="item.scouterRating !== 'No rating'"
                  >‚≠ê</span
                >
              </div>
              <p
                class="text-[8px] sm:text-[10px] text-gray-500 truncate max-w-[60px] sm:max-w-[80px]"
                *ngIf="item.scouterRating !== 'No rating'"
              >
                {{ item.scouterRating.split("stars")[1] || "" }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div
        *ngIf="ratingList.length === 0"
        class="text-center py-8 sm:py-12 text-gray-500"
      >
        <ion-icon
          name="stats-chart-outline"
          class="text-3xl sm:text-4xl mb-2 sm:mb-3 opacity-50"
        ></ion-icon>
        <p class="text-xs sm:text-sm">No engagement history available</p>
        <p class="text-[10px] sm:text-xs mt-1">
          Complete an engagement to see performance data
        </p>
      </div>

      <!-- Pagination Controls - Responsive -->
      <div
        *ngIf="ratingList.length > engagementsPerPage"
        class="flex flex-col sm:flex-row justify-between items-center gap-4 pt-4 mt-4 border-t border-gray-200"
      >
        <!-- Page Info - Mobile & Desktop -->
        <div class="text-[10px] sm:text-xs text-gray-600 order-2 sm:order-1">
          <span class="hidden sm:inline">Showing </span>
          <span class="font-medium">{{
            (currentEngagementPage - 1) * engagementsPerPage + 1
          }}</span>
          <span> - </span>
          <span class="font-medium">
            {{
              Math.min(
                currentEngagementPage * engagementsPerPage,
                ratingList.length
              )
            }}
          </span>
          <span class="hidden sm:inline">
            of {{ ratingList.length }} engagements</span
          >
          <span class="sm:hidden">/{{ ratingList.length }}</span>
        </div>

        <!-- Pagination Buttons - Responsive -->
        <div
          class="flex items-center gap-1 sm:gap-2 order-1 sm:order-2 w-full sm:w-auto justify-center"
        >
          <!-- Previous Button -->
          <button
            (click)="prevEngagementPage()"
            [disabled]="currentEngagementPage === 1"
            class="flex items-center gap-0.5 sm:gap-1 px-2 sm:px-3 py-1 sm:py-1.5 text-[10px] sm:text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition"
          >
            <ion-icon
              name="chevron-back-outline"
              class="text-[10px] sm:text-xs"
            ></ion-icon>
            <span class="hidden xs:inline sm:inline">Prev</span>
          </button>

          <!-- Page Numbers - Desktop Only -->
          <div class="hidden sm:flex items-center gap-1">
            <!-- First Page -->
            <button
              (click)="goToEngagementPage(1)"
              [class.bg-blue-600]="currentEngagementPage === 1"
              [class.text-white]="currentEngagementPage === 1"
              [class.text-gray-700]="currentEngagementPage !== 1"
              class="w-7 h-7 sm:w-8 sm:h-8 flex items-center justify-center text-xs font-medium rounded-lg hover:bg-gray-100 transition"
            >
              1
            </button>

            <!-- Ellipsis if needed -->
            <span *ngIf="currentEngagementPage > 3" class="text-gray-400 px-1">
              ...
            </span>

            <!-- Middle Pages -->
            <ng-container *ngFor="let page of cachedPageRange">
              <button
                *ngIf="page > 1 && page < totalEngagementPages"
                (click)="goToEngagementPage(page)"
                [class.bg-blue-600]="currentEngagementPage === page"
                [class.text-white]="currentEngagementPage === page"
                [class.text-gray-700]="currentEngagementPage !== page"
                class="w-7 h-7 sm:w-8 sm:h-8 flex items-center justify-center text-xs font-medium rounded-lg hover:bg-gray-100 transition"
              >
                {{ page }}
              </button>
            </ng-container>

            <!-- Ellipsis if needed -->
            <span
              *ngIf="currentEngagementPage < totalEngagementPages - 2"
              class="text-gray-400 px-1"
            >
              ...
            </span>

            <!-- Last Page -->
            <button
              *ngIf="totalEngagementPages > 1"
              (click)="goToEngagementPage(totalEngagementPages)"
              [class.bg-blue-600]="
                currentEngagementPage === totalEngagementPages
              "
              [class.text-white]="
                currentEngagementPage === totalEngagementPages
              "
              [class.text-gray-700]="
                currentEngagementPage !== totalEngagementPages
              "
              class="w-7 h-7 sm:w-8 sm:h-8 flex items-center justify-center text-xs font-medium rounded-lg hover:bg-gray-100 transition"
            >
              {{ totalEngagementPages }}
            </button>
          </div>

          <!-- Mobile Page Indicator -->
          <span
            class="sm:hidden text-xs font-medium text-gray-700 px-2 py-1 bg-gray-100 rounded-lg"
          >
            {{ currentEngagementPage }}/{{ totalEngagementPages }}
          </span>

          <!-- Next Button -->
          <button
            (click)="nextEngagementPage()"
            [disabled]="currentEngagementPage === totalEngagementPages"
            class="flex items-center gap-0.5 sm:gap-1 px-2 sm:px-3 py-1 sm:py-1.5 text-[10px] sm:text-xs font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition"
          >
            <span class="hidden xs:inline sm:inline">Next</span>
            <ion-icon
              name="chevron-forward-outline"
              class="text-[10px] sm:text-xs"
            ></ion-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
