<ion-header>
  <app-scouter-header
    [class.header-hidden]="headerHidden"
    [class.header-visible]="!headerHidden"
  >
  </app-scouter-header>
</ion-header>

<div *ngIf="showSpinner" class="fixed inset-0 flex items-center justify-center bg-white z-50">
  <app-spinner [loadingText]="loading"></app-spinner>
</div>

<ion-content class="ion-padding" #pageContent>
  <div class="bg-[#F2F4F7]">
    <!-- Debug buttons (optional) -->
    <!-- Debug buttons removed in cleanup -->

    <!-- Loading State for Profile -->
<!--    <div *ngIf="isLoadingProfile" class="minimal-loading">-->
<!--      <div class="minimal-spinner"></div>-->
<!--      <p class="minimal-text">Loading profile...</p>-->
<!--    </div>-->

    <div class="space-y-4 mt-10" *ngIf="!isLoadingProfile">
      <!-- Security Question Banner -->
      <div
        class="dark-card-background relative rounded-lg p-6 mb-6 overflow-hidden"
        *ngIf="securityQuestionCount === 0"
      >
        <div class="absolute inset-0 bg-black bg-opacity-60 z-0"></div>
        <div class="relative z-10 text-white">
          <div class="flex items-center gap-3 mb-3">
            <ion-icon
              class="h-7 w-7"
              name="information-circle-outline"
            ></ion-icon>
            <span class="font-normal text-[16px] leading-tight">
              Why haven't you created your security questions yet?
            </span>
          </div>
          <ion-button
            fill="clear"
            class="bg-transparent border border-white rounded-lg text-white hover:bg-white hover:cursor-pointer hover:text-black"
            (click)="scrollToSecurityQuestions()"
          >
            Create Security Questions
          </ion-button>
        </div>
      </div>

      <!-- Upload Profile Picture Banner -->
      <div
        class="dark-card-background relative rounded-lg p-6 mb-6 overflow-hidden"
        *ngIf="!hasExistingProfilePicture"
      >
        <div class="absolute inset-0 bg-black bg-opacity-60 z-0"></div>
        <div class="relative z-10 text-white">
          <div class="flex items-center gap-3 mb-3">
            <ion-icon
              class="h-7 w-7"
              name="information-circle-outline"
            ></ion-icon>
            <span class="font-normal text-[16px] leading-tight">
              Why haven't you uploaded your profile picture yet?
            </span>
          </div>
          <ion-button
            fill="clear"
            class="bg-transparent border border-white rounded-lg text-white hover:bg-white hover:cursor-pointer hover:text-black"
            (click)="scrollToProfilePicture()"
          >
            Upload picture
          </ion-button>
        </div>
      </div>
    </div>

    <div class="mt-12" *ngIf="!isLoadingProfile">
      <div class="logcomplainModalBG h-[69px] pt-2">
        <p class="text-white text-xl font-bold item-start mt-3 px-5">
          Personal Information
        </p>
      </div>

      <div class="p-6">
        <!-- Profile Picture -->
        <p class="mt-3 pb-3 text-gray-600" #profilePicture>Profile Picture</p>
        <div class="flex flex-col mb-6">
          <div
            (click)="openProfileImagePicker(); $event.stopPropagation()"
            class="w-28 h-28 rounded-full border-4 border-gray-600 flex items-center justify-center cursor-pointer hover:border-gray-700 transition-colors"
          >
            <div
              class="w-24 h-24 rounded-full border-4 border-white bg-gray-200 flex items-center justify-center relative overflow-hidden"
            >
              <!-- Show actual profile picture if it exists -->
              <img
                *ngIf="profileImage && hasExistingProfilePicture"
                [src]="profileImage"
                alt="Profile"
                class="w-full h-full object-cover rounded-full"
                (error)="handleImageError($event)"
              />

              <!-- Show placeholder when no profile picture -->
              <div
                *ngIf="!profileImage || !hasExistingProfilePicture"
                class="w-full h-full flex items-center justify-center text-gray-400 bg-gray-300 rounded-full"
              >
                <ion-icon
                  name="person-outline"
                  class="text-3xl text-gray-500"
                ></ion-icon>
              </div>

              <input
                type="file"
                #fileInput
                accept="image/*"
                class="hidden"
                (change)="onFileSelected($event)"
              />
              <!-- Edit pencil icon - show when editing -->
              <div
                class="absolute bottom-0 right-0 translate-x-1/4 translate-y-1/4 bg-white p-1 rounded-full cursor-pointer w-7 h-7 flex items-center justify-center shadow-md border border-gray-300"
                (click)="$event.stopPropagation(); triggerFileInput()"
                *ngIf="isEditing"
              >
                <ion-icon
                  name="pencil-outline"
                  class="text-gray-700 text-base"
                ></ion-icon>
              </div>
            </div>
          </div>

          <!-- Profile Picture Actions - ALWAYS show when editing -->
          <div class="profile-image-actions mt-4" *ngIf="isEditing">
            <ion-button
              fill="clear"
              size="small"
              (click)="triggerFileInput()"
              class="edit-button text-[#000000]"
            >
              <ion-icon name="camera" slot="start"></ion-icon>
              {{
                hasExistingProfilePicture ? "Change Picture" : "Upload Picture"
              }}
            </ion-button>

            <!-- Show Remove button only when there's an actual profile picture -->
            <ion-button
              *ngIf="hasExistingProfilePicture && profileImage"
              fill="clear"
              size="small"
              color="danger"
              (click)="removeProfilePicture()"
              class="remove-button"
            >
              <ion-icon name="trash" slot="start"></ion-icon>
              Remove Picture
            </ion-button>
          </div>
        </div>

        <!-- Full Name -->
        <div class="mb-4">
          <label class="block text-gray-600 text-sm mb-2">Full Name *</label>
          <input
            type="text"
            [(ngModel)]="profileData.fullName"
            placeholder="Full Name"
            [readonly]="!isEditing"
            [class.bg-gray-100]="!isEditing"
            [class.cursor-not-allowed]="!isEditing"
            class="w-full border-none rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md transition-colors"
          />
        </div>

        <!-- Phone Number -->
        <div class="mb-4">
          <label class="block text-gray-600 text-sm mb-2">Phone Number *</label>
          <input
            type="tel"
            [(ngModel)]="profileData.phoneNumber"
            placeholder="e.g 0908123456"
            [readonly]="!isEditing"
            [class.bg-gray-100]="!isEditing"
            [class.cursor-not-allowed]="!isEditing"
            class="w-full border-none rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md transition-colors"
          />
        </div>

        <!-- Email -->
        <div class="mb-4">
          <label class="block text-gray-600 text-sm mb-2"
            >Email Address *</label
          >
          <input
            type="email"
            [(ngModel)]="profileData.email"
            placeholder="baba.saala@gmail.com"
            readonly
            class="w-full border-none rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md transition-colors"
          />
        </div>

        <!-- Password -->
        <div class="mb-4">
          <label class="block text-gray-600 text-sm mb-2">Password</label>
          <input
            type="password"
            placeholder="********************"
            class="w-full border-none rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md"
            readonly
          />
        </div>

        <!-- Location -->
        <div class="mb-4">
          <label class="block text-gray-600 text-sm mb-2">Location</label>
          <input
            type="text"
            [(ngModel)]="profileData.location"
            placeholder="e.g Ikeja, Lagos"
            [readonly]="!isEditing"
            [class.bg-gray-100]="!isEditing"
            [class.cursor-not-allowed]="!isEditing"
            class="w-full border-none rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md transition-colors"
          />
        </div>
      </div>
    </div>

    <div class="logcomplainModalBG h-[69px] pt-2" *ngIf="!isLoadingProfile">
      <p class="text-white text-xl font-bold item-start mt-3 px-5">
        Other Details
      </p>
    </div>

    <div class="mt-6 px-6" *ngIf="!isLoadingProfile">
      <!-- Organisation Type -->
      <div class="mb-4">
        <label class="block text-gray-600 text-sm mb-2">
          Your Organization Type(s):
        </label>

        <div class="relative">
          <div
            class="w-full border border-[#D9DCE5] rounded-md px-4 py-3 bg-[#F6F6F6] focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 shadow-sm min-h-[56px] flex flex-wrap items-center gap-2 cursor-text transition-colors"
            (click)="focusOrgInput()"
            [class.bg-gray-100]="!isEditing"
            [class.cursor-not-allowed]="!isEditing"
          >
            <!-- Selected Tags -->
            <ng-container
              *ngIf="selectedOrgTypes && selectedOrgTypes.length > 0"
            >
              <span
                *ngFor="
                  let org of selectedOrgTypes;
                  let i = index;
                  trackBy: trackByOrgType
                "
                class="bg-gray-200 rounded-lg px-3 py-1 flex items-center gap-1 text-sm border border-gray-300"
              >
                {{ org }}
                <button
                  *ngIf="isEditing"
                  type="button"
                  (click)="removeOrgType(i); $event.stopPropagation()"
                  class="text-gray-500 hover:text-red-500 text-lg leading-none ml-1 transition-colors"
                >
                  √ó
                </button>
              </span>
            </ng-container>

            <!-- Show empty state when no org types -->
            <div
              *ngIf="!selectedOrgTypes || selectedOrgTypes.length === 0"
              class="text-gray-400 text-sm"
            >
              No organization types added
            </div>

            <!-- Type Input Field -->
            <input
              #orgInput
              type="text"
              placeholder="Type and press Enter"
              [readonly]="!isEditing"
              [(ngModel)]="orgTypeInput"
              (keydown.enter)="addOrgTypeFromInput($event)"
              (input)="onOrgTypeTyping($event)"
              class="flex-1 min-w-[120px] bg-transparent border-none outline-none placeholder-gray-400 transition-colors"
              [class.cursor-not-allowed]="!isEditing"
              [class.placeholder-gray-300]="!isEditing"
            />
          </div>
        </div>

        <p class="text-xs text-gray-500 mt-1" *ngIf="isEditing">
          Type your organization type and press Enter to add
        </p>
        <p class="text-xs text-gray-400 mt-1" *ngIf="!isEditing">
          Switch to edit mode to modify organization types
        </p>
      </div>

      <!-- Scouting Purpose -->
      <div class="mb-4">
        <label class="block text-gray-600 text-sm mb-2">
          Scouting Purpose (Reasons for Hiring talent)
        </label>
        <input
          type="text"
          [(ngModel)]="profileData.scoutingPurpose"
          placeholder="Painting"
          [readonly]="!isEditing"
          [class.bg-gray-100]="!isEditing"
          [class.cursor-not-allowed]="!isEditing"
          class="w-full border-none rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md transition-colors"
        />
      </div>

      <!-- Pay Range -->
      <div class="mb-4">
        <label class="block text-gray-600 text-sm mb-2">Pay Range</label>
        <input
          type="text"
          [(ngModel)]="profileData.payRange"
          placeholder="e.g., 750k or 750"
          [readonly]="!isEditing"
          [class.bg-gray-100]="!isEditing"
          [class.cursor-not-allowed]="!isEditing"
          class="w-full border-none rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md transition-colors"
        />
        <p class="text-xs text-gray-500 mt-1" *ngIf="isEditing">
          Enter pay range (e.g., 750k, 750, etc.)
        </p>
      </div>

      <!-- Action Buttons -->
      <div class="space-y-4 py-8">
        <button
          class="bg-[#101828] rounded-lg w-full py-3 text-white font-medium cursor-pointer disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center transition-colors"
          (click)="openConfirmationPopup()"
          [disabled]="isSavingProfile"
        >
          <span *ngIf="isSavingProfile" class="flex items-center gap-2">
            <ion-icon name="refresh-outline" class="animate-spin"></ion-icon>
            Saving...
          </span>
          <span *ngIf="!isSavingProfile">
            {{ isEditing ? "Save Changes" : "Edit Profile" }}
          </span>
        </button>

        <!-- Show Return button as secondary option -->
        <button
          class="bg-transparent border border-gray-300 rounded-lg w-full py-3 text-gray-600 font-medium cursor-pointer hover:bg-gray-50 transition-colors"
          (click)="goBack()"
        >
          Return
        </button>
      </div>
    </div>

    <!-- Security Questions Section -->
    <div
      class="logcomplainModalBG h-[69px] pt-2 mt-12"
      #securityQuestionsSection
      *ngIf="!isLoadingProfile"
    >
      <p class="text-white text-xl font-bold item-start mt-3 px-5">
        Security Questions
      </p>
    </div>

    <div class="mb-4 px-6 py-6" *ngIf="!isLoadingProfile">
      <label class="block text-gray-600 text-sm mb-4">
        You're advised to create up to {{ maxSecurityQuestions }} security
        questions for account recovery. You currently have
        {{ securityQuestions.length }} question{{
          securityQuestions.length !== 1 ? "s" : ""
        }}.
      </label>

      <!-- Status Indicator -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <ion-icon
              name="information-circle-outline"
              class="text-blue-600"
            ></ion-icon>
            <span class="text-blue-800 text-sm font-medium">
              {{ securityQuestions.length }}/{{ maxSecurityQuestions }}
              questions
            </span>
          </div>
          <div
            *ngIf="securityQuestions.length < maxSecurityQuestions"
            class="text-blue-600 text-sm"
          >
            You can add
            {{ maxSecurityQuestions - securityQuestions.length }} more
          </div>
        </div>
      </div>

      <!-- Error Message Display -->
      <!-- <div
        *ngIf="securityQuestionErrorMessage"
        class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg"
      >
        <div class="flex items-center gap-2 text-red-700">
          <ion-icon name="warning-outline"></ion-icon>
          <span class="text-sm">{{ securityQuestionErrorMessage }}</span>
        </div>
      </div> -->

      <!-- Loading State -->
      <div *ngIf="isLoadingSecurityQuestions" class="text-center py-8">
        <div class="flex flex-col items-center justify-center">
          <div class="relative">
            <div
              class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#101828]"
            ></div>
            <ion-icon
              name="shield-checkmark-outline"
              class="absolute inset-0 m-auto text-lg text-[#101828]"
            ></ion-icon>
          </div>
          <p class="text-gray-500 mt-4">Loading security questions...</p>
        </div>
      </div>

      <!-- Security Questions Display Section -->
      <div
        class="space-y-4 mb-6"
        *ngIf="securityQuestions.length > 0 && !isEditingSecurityQuestions"
      >
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-700">
            Your Security Questions
          </h3>
          <div class="text-sm">
            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full">
              {{ totalQuestionsCount }}/{{ maxSecurityQuestions }}
            </span>
          </div>
        </div>

        <div class="space-y-4">
          <div
            *ngFor="let qa of securityQuestions; let i = index"
            class="p-4 border border-gray-200 rounded-lg bg-white hover:border-gray-300 transition-colors"
          >
            <div class="flex justify-between items-start mb-3">
              <div class="flex items-center gap-2">
                <div
                  class="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center"
                >
                  <span class="text-gray-600 font-semibold text-xs">{{
                    i + 1
                  }}</span>
                </div>
                <span class="text-xs text-blue-500" *ngIf="qa.isHashed">
                  üîê Secured
                </span>
              </div>
              <div class="flex gap-2">
                <button
                  (click)="editQuestion(i)"
                  class="text-blue-500 hover:text-blue-700 p-1.5 rounded-full hover:bg-blue-50 transition"
                  title="Edit question"
                >
                  <ion-icon name="create-outline" class="text-lg"></ion-icon>
                </button>
                <button
                  (click)="deleteQuestion(i)"
                  class="text-red-500 hover:text-red-700 p-1.5 rounded-full hover:bg-red-50 transition"
                  title="Delete question"
                >
                  <ion-icon name="trash-outline" class="text-lg"></ion-icon>
                </button>
              </div>
            </div>

            <!-- Question -->
            <label class="block text-gray-600 text-sm mb-2 font-medium">
              Question {{ i + 1 }}
            </label>
            <div class="p-3 bg-gray-50 rounded border border-gray-100 mb-3">
              <p class="text-gray-700">{{ qa.question }}</p>
            </div>

            <!-- Answer -->
            <label class="block text-gray-600 text-sm mb-2 font-medium">
              Answer {{ i + 1 }}
            </label>
            <div class="relative">
              <div
                class="p-3 bg-gray-50 rounded border border-gray-100 flex items-center justify-between hover:bg-gray-100 transition-colors cursor-pointer"
                (click)="toggleAnswerVisibility(i)"
              >
                <span class="text-gray-500 tracking-wider">
                  {{ getDisplayAnswer(qa) }}
                </span>
                <button
                  type="button"
                  class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-full hover:bg-gray-200"
                  [class.text-blue-500]="qa.showAnswer"
                >
                  <ion-icon
                    [name]="qa.showAnswer ? 'eye-off-outline' : 'eye-outline'"
                    class="text-lg"
                  ></ion-icon>
                </button>
              </div>

              <!-- Info for hashed answers -->
              <div
                *ngIf="qa.showAnswer && qa.isHashed"
                class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded text-xs text-blue-700"
              >
                <div class="flex items-center gap-2">
                  <ion-icon
                    name="shield-checkmark-outline"
                    class="text-blue-600"
                  ></ion-icon>
                  <span>Secured answer - for verification purposes only</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div
        *ngIf="
          !isLoadingSecurityQuestions &&
          securityQuestions.length === 0 &&
          !isEditingSecurityQuestions
        "
        class="text-center py-8 border-2 border-dashed border-gray-300 rounded-lg mb-4"
      >
        <ion-icon
          name="help-circle-outline"
          class="text-4xl text-gray-400 mb-2"
        ></ion-icon>
        <p class="text-gray-500">No security questions set up yet</p>
        <p class="text-sm text-gray-400 mt-1">
          Create security questions for account recovery
        </p>
      </div>

      <!-- Action Buttons (View Mode) -->
      <div class="flex gap-2 mb-6" *ngIf="!isEditingSecurityQuestions">
        <button
          class="bg-[#101828] hover:bg-[#0d141f] rounded-lg px-5 py-2.5 text-white text-sm font-medium cursor-pointer flex items-center gap-2 transition-colors"
          (click)="toggleEditSecurityQuestions()"
        >
          <ion-icon name="add-outline" class="text-base"></ion-icon>
          {{
            securityQuestions.length > 0 ? "Edit Questions" : "Create Questions"
          }}
        </button>

        <button
          *ngIf="
            securityQuestions.length > 0 &&
            securityQuestions.length < maxSecurityQuestions
          "
          class="bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-200 rounded-lg px-5 py-2.5 text-sm font-medium cursor-pointer flex items-center gap-2 transition-colors"
          (click)="toggleEditSecurityQuestions()"
        >
          <ion-icon name="add-circle-outline" class="text-base"></ion-icon>
          Add More
        </button>
      </div>

      <!-- Edit/Add Questions Form -->
      <div class="space-y-6" *ngIf="isEditingSecurityQuestions">
        <!-- Information Box -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="flex items-start gap-3">
            <ion-icon
              name="information-circle-outline"
              class="text-blue-600 text-xl mt-0.5"
            ></ion-icon>
            <div>
              <p class="text-blue-800 font-medium mb-1">Important:</p>
              <ul class="text-blue-600 text-sm space-y-1">
                <li>‚Ä¢ Questions: Minimum 5 characters</li>
                <li>‚Ä¢ Answers: Minimum 3 characters</li>
                <li>‚Ä¢ Answers are case-insensitive</li>
                <li>‚Ä¢ Maximum {{ maxSecurityQuestions }} questions</li>
                <li *ngIf="securityQuestions.length > 0">
                  ‚Ä¢ Leave answer blank to keep existing secured answer
                </li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Questions Form -->
        <div class="space-y-4">
          <div
            *ngFor="let qa of tempSecurityQuestions; let tIdx = index"
            [attr.data-question-index]="tIdx"
            class="p-4 border border-gray-300 rounded-lg bg-white"
          >
            <div class="flex justify-between items-center mb-3">
              <div class="flex items-center gap-3">
                <div
                  class="w-6 h-6 bg-gray-100 rounded-full flex items-center justify-center"
                >
                  <span class="text-gray-600 font-semibold text-sm">{{
                    tIdx + 1
                  }}</span>
                </div>
                <label class="block text-gray-700 text-sm font-medium">
                  Question {{ tIdx + 1 }}
                </label>
              </div>
              <button
                *ngIf="tempSecurityQuestions.length > 1"
                class="text-red-500 hover:text-red-700 text-sm flex items-center gap-1.5 px-3 py-1.5 rounded hover:bg-red-50 transition"
                (click)="removeQuestion(tIdx)"
                [disabled]="isSavingSecurityQuestions"
                type="button"
              >
                <ion-icon name="trash-outline" class="text-base"></ion-icon>
                Remove
              </button>
            </div>

            <!-- Question Input -->
            <div class="mb-3">
              <input
                type="text"
                placeholder="e.g., What was your first pet's name?"
                [(ngModel)]="qa.question"
                [disabled]="isSavingSecurityQuestions"
                class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm placeholder:text-gray-400 disabled:bg-gray-100 disabled:cursor-not-allowed transition"
                [class.border-red-300]="hasInvalidQuestion(qa)"
              />
              <div class="flex justify-between items-center mt-1.5">
                <span
                  class="text-xs"
                  [class.text-red-500]="hasInvalidQuestion(qa)"
                  [class.text-gray-400]="!hasInvalidQuestion(qa)"
                >
                  {{ getQuestionValidationMessage(qa) }}
                </span>
                <span class="text-xs text-gray-400">
                  {{ qa.question.length || 0 }} chars
                </span>
              </div>
            </div>

            <!-- Answer Input -->
            <div>
              <label class="block text-gray-700 text-sm font-medium mb-2">
                Answer {{ tIdx + 1 }}
                <span
                  class="text-gray-400 font-normal text-xs"
                  *ngIf="!qa.isHashed"
                >
                  (will be secured)
                </span>
                <span
                  class="text-blue-500 font-normal text-xs"
                  *ngIf="qa.isHashed && qa.originalAnswer"
                >
                  (leave blank to keep existing answer)
                </span>
              </label>
              <div class="relative">
                <input
                  [type]="qa.showAnswer ? 'text' : 'password'"
                  [placeholder]="
                    qa.isHashed && qa.originalAnswer
                      ? 'Enter new answer or leave blank'
                      : 'Enter your answer'
                  "
                  [(ngModel)]="qa.answer"
                  [disabled]="isSavingSecurityQuestions"
                  class="w-full border border-gray-300 rounded-lg px-4 py-2.5 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm placeholder:text-gray-400 disabled:bg-gray-100 disabled:cursor-not-allowed transition"
                  [class.border-blue-300]="
                    qa.isHashed && qa.originalAnswer && !qa.answer
                  "
                />
                <button
                  type="button"
                  (click)="toggleEditAnswerVisibility(tIdx)"
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-full hover:bg-gray-200"
                  [disabled]="isSavingSecurityQuestions"
                  [class.text-blue-500]="qa.showAnswer"
                  [title]="qa.showAnswer ? 'Hide answer' : 'Show answer'"
                >
                  <ion-icon
                    [name]="qa.showAnswer ? 'eye-off-outline' : 'eye-outline'"
                    class="text-lg"
                  ></ion-icon>
                </button>
              </div>
              <!-- Reveal existing hashed answer section -->
              <div
                *ngIf="
                  qa.isHashed &&
                  qa.originalAnswer &&
                  (qa.answer === '' || qa.masked)
                "
                class="mt-2 flex items-center gap-2"
              >
                <input
                  type="password"
                  placeholder="Enter current answer to reveal"
                  [(ngModel)]="qa.revealAttempt"
                  [disabled]="qa.verifyInProgress || isSavingSecurityQuestions"
                  class="flex-1 border border-gray-300 rounded-lg px-3 py-2 placeholder:text-gray-400"
                />
                <button
                  type="button"
                  (click)="verifyExistingAnswer(tIdx)"
                  [disabled]="qa.verifyInProgress || isSavingSecurityQuestions"
                  class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm"
                >
                  <span *ngIf="!qa.verifyInProgress">Verify</span>
                  <span *ngIf="qa.verifyInProgress">Verifying...</span>
                </button>
              </div>
              <div *ngIf="qa.revealed" class="mt-1 text-sm text-green-600">
                ‚úÖ Answer verified and revealed for editing
              </div>
              <div class="flex justify-between items-center mt-1.5">
                <span
                  class="text-xs"
                  [class.text-red-500]="hasInvalidAnswer(qa)"
                  [class.text-gray-400]="!hasInvalidAnswer(qa)"
                >
                  {{ getAnswerValidationMessage(qa) }}
                </span>
                <span class="text-xs text-gray-400">
                  {{ qa.answer.length || 0 }} chars
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Add New Question Button -->
        <button
          class="bg-gray-100 hover:bg-gray-200 border-2 border-dashed border-gray-300 rounded-lg px-4 py-3 text-sm font-medium w-full cursor-pointer flex items-center justify-center gap-2 transition disabled:opacity-50 disabled:cursor-not-allowed"
          (click)="addNewQuestion()"
          [disabled]="
            tempSecurityQuestions.length >= maxSecurityQuestions ||
            isSavingSecurityQuestions
          "
          type="button"
        >
          <ion-icon name="add-circle-outline" class="text-lg"></ion-icon>
          Add Another Question
          <span class="text-xs text-gray-500 ml-1">
            ({{ tempSecurityQuestions.length }}/{{ maxSecurityQuestions }})
          </span>
        </button>

        <!-- Action buttons -->
        <div
          class="flex flex-col sm:flex-row gap-3 pt-6 border-t border-gray-200"
        >
          <button
            class="bg-[#101828] hover:bg-[#0d141f] rounded-lg flex-1 py-3 text-white font-medium cursor-pointer flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
            (click)="saveSecurityQuestions()"
            [disabled]="
              !canSaveSecurityQuestions() || isSavingSecurityQuestions
            "
            type="button"
          >
            <ion-icon
              name="save-outline"
              *ngIf="!isSavingSecurityQuestions"
            ></ion-icon>
            <span>{{
              isSavingSecurityQuestions ? "Saving..." : "Save All Questions"
            }}</span>
          </button>

          <button
            class="bg-transparent border border-gray-300 hover:bg-gray-50 rounded-lg flex-1 py-3 text-gray-600 font-medium cursor-pointer transition-colors"
            (click)="cancelEditSecurityQuestions()"
            [disabled]="isSavingSecurityQuestions"
            type="button"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</ion-content>
